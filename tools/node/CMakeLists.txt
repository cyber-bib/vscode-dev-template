# https://nodejs.org/dist/v14.17.3/node-v14.17.3-win-x64.zip
cmake_minimum_required(VERSION 3.20.0 FATAL_ERROR)

project(Node-Install
	VERSION 0.0.0.1
	DESCRIPTION "Python Installition module"
	HOMEPAGE_URL "..."
  LANGUAGES NONE
)

list(APPEND CMAKE_MODULE_PATH "${CMAKE_CURRENT_SOURCE_DIR}/../../cmake")
include(Helpers)
add_project_defaults()

# if(IS_WINDOWS)
# endif()

set(NODE_POSTFIX "zip")
set(NODE_VER "14.17.3")
set(NODE_ARCH "x64")
set(NODE_INSTALLER_NAME "node-v${NODE_VER}-win-${NODE_ARCH}.${NODE_POSTFIX}")
set(NODE_INSTALLER_PATH "${CMAKE_ARCHIVE_OUTPUT_DIRECTORY}/${NODE_INSTALLER_NAME}")
set(NODE_INSTALLER_SOURCE "https://nodejs.org/dist/v${NODE_VER}/${NODE_INSTALLER_NAME}")

set(NPM_EXECUTABLE ${CMAKE_RUNTIME_OUTPUT_DIRECTORY}/npm.cmd)
set(NODE_EXECUTABLE ${CMAKE_RUNTIME_OUTPUT_DIRECTORY}/node.exe)
if(NOT EXISTS ${NODE_EXECUTABLE})
  if(EXISTS ${NODE_INSTALLER_PATH})
    message(STATUS "Node installer found.")
  else()
    message(STATUS "Node not found. Downloading from ${NODE_INSTALLER_SOURCE}")
    file(DOWNLOAD
      "${NODE_INSTALLER_SOURCE}"
      "${NODE_INSTALLER_PATH}"
      SHOW_PROGRESS
    )
  endif()

  file(ARCHIVE_EXTRACT
    INPUT "${NODE_INSTALLER_PATH}"
    DESTINATION "${CMAKE_RUNTIME_OUTPUT_DIRECTORY}"
    VERBOSE
  )

  file(COPY "${CMAKE_RUNTIME_OUTPUT_DIRECTORY}/node-v${NODE_VER}-win-${NODE_ARCH}/"
    DESTINATION "${CMAKE_RUNTIME_OUTPUT_DIRECTORY}"
  )
  file(REMOVE_RECURSE "${CMAKE_RUNTIME_OUTPUT_DIRECTORY}/node-v${NODE_VER}-win-${NODE_ARCH}")

  set(NODE_DIR ${CMAKE_RUNTIME_OUTPUT_DIRECTORY})
  set(NODE_EXECUTABLE ${CMAKE_RUNTIME_OUTPUT_DIRECTORY}/node.exe)
  set(NPM_EXECUTABLE ${CMAKE_RUNTIME_OUTPUT_DIRECTORY}/npm.cmd)
else()
  execute_process(
    COMMAND powershell ${NODE_EXECUTABLE} --version
    WORKING_DIRECTORY ${CMAKE_RUNTIME_OUTPUT_DIRECTORY}
    RESULT_VARIABLE NODE_RESULT
    OUTPUT_VARIABLE NODE_OUTPUT
  )
  string(REPLACE "\n" "" NODE_OUTPUT ${NODE_OUTPUT})
  string(REPLACE "v" "" NODE_OUTPUT ${NODE_OUTPUT})
  message(STATUS "Found node version: ${NODE_OUTPUT}")

  execute_process(
    COMMAND powershell ${NPM_EXECUTABLE} --version
    WORKING_DIRECTORY ${CMAKE_RUNTIME_OUTPUT_DIRECTORY}
    RESULT_VARIABLE NPM_RESULT
    OUTPUT_VARIABLE NPM_OUTPUT
  )
  string(REPLACE "\n" "" NPM_OUTPUT ${NPM_OUTPUT})
  message(STATUS "Found npm version: ${NPM_OUTPUT}")
endif()

set(NODE_EXECUTABLE ${NODE_EXECUTABLE} PARENT_SCOPE)
set(NPM_EXECUTABLE ${NPM_EXECUTABLE} PARENT_SCOPE)